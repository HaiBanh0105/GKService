<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ giao d·ªãch</title>
    <link rel="stylesheet" href="login.css">
</head>
<body>
    <div class="login-container" style="max-width: 800px;">
        <div class="logo">
            <h1>üéì TDTU</h1>
            <p>L·ªãch s·ª≠ giao d·ªãch h·ªçc ph√≠</p>
        </div>

        <div class="user-info-section" style="display:block;">
            <div class="user-info-title">Th√¥ng tin ng∆∞·ªùi n·ªôp</div>
            <div class="user-info-item"><span class="user-info-label">H·ªç t√™n</span><span id="uFullname" class="user-info-value"></span></div>
            <div class="user-info-item"><span class="user-info-label">Email</span><span id="uEmail" class="user-info-value"></span></div>
            <div class="user-info-item"><span class="user-info-label">S·ªë d∆∞</span><span id="uBalance" class="user-info-value"></span></div>
        </div>

        <div class="transaction-history" id="txList"></div>

        <button class="continue-btn" onclick="window.location.href='index.html'">Quay l·∫°i</button>
    </div>

    <script>
(function() {
    const userJson = localStorage.getItem('user');
    if (!userJson) { window.location.href = 'login.html'; return; }
    let user = null; try { user = JSON.parse(userJson); } catch { user = null; }
    if (!user || !user.id) { window.location.href = 'login.html'; return; }

    document.getElementById('uFullname').textContent = user.fullname || '';
    document.getElementById('uEmail').textContent = user.email || '';
    document.getElementById('uBalance').textContent = (user.balance || 0).toLocaleString('vi-VN') + ' VND';

    async function loadHistory() {
        try {
            const res = await fetch(`http://localhost:8080/backend/auth/transactions.php?userId=${user.id}`);
            const data = await res.json();
            const listEl = document.getElementById('txList');
            listEl.innerHTML = '';
            if (data.status !== 'success' || !Array.isArray(data.transactions) || data.transactions.length === 0) {
                listEl.innerHTML = '<div class="transaction-item">Ch∆∞a c√≥ giao d·ªãch</div>';
                return;
            }
            data.transactions.forEach(t => {
                const div = document.createElement('div');
                div.className = 'transaction-item';
                const amt = Number(t.Amount || 0);
                const created = t.CreatedAt ? new Date(t.CreatedAt).toLocaleString('vi-VN') : '';
                div.innerHTML = `<div><strong>${t.StudentID || ''}</strong> - ${t.StudentName || ''}</div>
                                 <div>S·ªë ti·ªÅn: ${amt.toLocaleString('vi-VN')} VND</div>
                                 <div>Th·ªùi gian: ${created}</div>`;
                listEl.appendChild(div);
            });
        } catch (e) {
            console.error(e);
            document.getElementById('txList').innerHTML = '<div class="transaction-item">L·ªói t·∫£i l·ªãch s·ª≠</div>';
        }
    }

    loadHistory();
})();
    </script>
</body>
</html>
