<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống đăng ký thành công</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Học phí</h1>
        </div>

        <div class="form-container">
            <div class="success-message" id="successMessage">
                <strong>Đăng ký thành công!</strong> Thông tin của bạn đã được ghi nhận.
            </div>

            <form id="registrationForm">
                <!-- Section 1: Thông tin người nộp tiền -->
                <div class="section">
                    <h2 class="section-title">Thông tin người nộp tiền</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="submitterName">Họ và tên <span class="required">*</span></label>
                            <input type="text" id="submitterName" name="submitterName" required>
                        </div>
                        <div class="form-group">
                            <label for="submitterPhone">Số điện thoại <span class="required">*</span></label>
                            <input type="tel" id="submitterPhone" name="submitterPhone" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="submitterEmail">Địa chỉ email <span class="required">*</span></label>
                            <input type="email" id="submitterEmail" name="submitterEmail" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <button type="button" id="viewHistoryBtn" class="continue-btn">Xem lịch sử giao dịch</button>
                        </div>
                    </div>

                    <p style="color: #666; font-style: italic; margin-top: 10px;">
                        <strong>Lưu ý:</strong> Các thông tin này hệ thống phải tự động điền cho người dùng, và khóa lại để người dùng không được chỉnh sửa.
                    </p>
                </div>

                <!-- Section 2: Thông tin học phí -->
                <div class="section">
                    <h2 class="section-title">Thông tin học phí</h2>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1; min-width: 250px;">
                            <label for="studentId">Mã số sinh viên <span class="required">*</span></label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="studentId" name="studentId" required style="flex: 1;">
                                <button type="button" id="searchTuitionBtn" style="white-space: nowrap; padding: 0 16px; border-radius: 8px; border: 2px solid #667eea; background: #fff; color: #667eea; font-weight: 600; cursor: pointer;">Tìm học phí</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="studentName">Họ tên sinh viên <span class="required">*</span></label>
                            <input type="text" id="studentName" name="studentName" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tuitionStatus">Trạng thái học phí</label>
                            <input type="text" id="tuitionStatus" name="tuitionStatus" readonly style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label for="cardNumber">Số tiền cần nộp <span class="required">*</span></label>
                            <input type="number" id="feeAmount" name="feeAmount" required placeholder="Nhập số tiền VND">
                        </div>
                    </div>

                    <div class="banking-info">
                        <h4 style="margin-bottom: 15px; color: #667eea;">Thông tin chuyển khoản</h4>
                        <p><strong>Ngân hàng:</strong> iBanking (được thiết lập tự động)</p>
                        <p><strong>Số tài khoản:</strong> <span id="accountNumber">1234567890</span></p>
                        <p><strong>Tên tài khoản:</strong> TDTU - Hệ thống thanh toán học phí</p>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                            Hệ thống sẽ gửi mã OTP tới email người nộp tiền. Vui lòng kiểm tra hộp thư.
                        </p>
                    </div>
                </div>

                <!-- Section 3: Thông tin thanh toán -->
                <div class="section">
                    <h2 class="section-title">Thông tin thanh toán</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payerBalance">Số dư khả dụng của người nộp tiền</label>
                            <input type="number" id="payerBalance" name="payerBalance" readonly value="5000000" style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label for="tuitionFee">Số tiền học phí cần thanh toán</label>
                            <input type="number" id="tuitionFee" name="tuitionFee" readonly style="background: #f5f5f5;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="agreements">Các thỏa thuận và điều khoản</label>
                        <textarea id="agreements" name="agreements" rows="4" readonly style="background: #f5f5f5;">
Hệ thống chỉ cho phép thanh toán toàn bộ giá trị của phần học phí cần thanh toán. Số tiền học phí cần thanh toán phải nhỏ hơn hoặc bằng số dư khả dụng của người nộp tiền.
                        </textarea>
                    </div>

                    <div class="fee-display">
                        <h3>Tổng số tiền cần thanh toán</h3>
                        <div class="fee-amount" id="totalAmount">0 VND</div>
                        <p>Vui lòng kiểm tra lại thông tin trước khi xác nhận</p>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    Xác nhận giao dịch
                </button>
            </form>
        </div>
    </div>

    <script>
(function() {
    const userJson = localStorage.getItem('user');
    if (!userJson) { window.location.href = 'login.html'; return; }

    let user = null;
    try { user = JSON.parse(userJson); } catch { user = null; }
    if (!user || !user.username) { window.location.href = 'login.html'; return; }

    const nameInput = document.getElementById('submitterName');
    const phoneInput = document.getElementById('submitterPhone');
    const emailInput = document.getElementById('submitterEmail');
    const balanceInput = document.getElementById('payerBalance');
    const tuitionFeeInput = document.getElementById('tuitionFee');
    const feeAmountInput = document.getElementById('feeAmount');
    const totalAmountEl = document.getElementById('totalAmount');
    const submitBtn = document.getElementById('submitBtn');
    const studentIdInput = document.getElementById('studentId');
    const studentNameInput = document.getElementById('studentName');
    const searchTuitionBtn = document.getElementById('searchTuitionBtn');
    const tuitionStatusInput = document.getElementById('tuitionStatus');
    const viewHistoryBtn = document.getElementById('viewHistoryBtn');

    const statusMap = { 'Completed': 'hoàn thành', 'Processing': 'đang xử lý', 'Unpaid': 'chưa nộp' };

    nameInput.value = user.fullname || '';
    phoneInput.value = user.phone || '';
    emailInput.value = user.email || '';
    balanceInput.value = typeof user.balance === 'number' ? Math.floor(user.balance) : 0;

    [nameInput, phoneInput, emailInput].forEach(el => { el.readOnly = true; el.style.background = '#f5f5f5'; el.style.color = '#666'; });

    viewHistoryBtn.addEventListener('click', () => { window.location.href = 'history.html'; });

    const updateTotals = () => {
        const amount = parseInt(feeAmountInput.value, 10) || 0;
        tuitionFeeInput.value = amount;
        totalAmountEl.textContent = amount.toLocaleString('vi-VN') + ' VND';
        const balance = parseInt(balanceInput.value, 10) || 0;
        submitBtn.disabled = !(amount > 0 && amount <= balance);
        if (amount > balance) { submitBtn.style.background = '#e74c3c'; submitBtn.textContent = 'Số dư không đủ'; } else { submitBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; submitBtn.textContent = 'Xác nhận giao dịch'; }
    };

    feeAmountInput.addEventListener('input', updateTotals);

    async function fetchTuitionByStudentId(studentId) {
        try {
            const res = await fetch(`http://localhost:8080/backend/tuition/get_tuition.php?studentId=${encodeURIComponent(studentId)}`);
            const data = await res.json();
            if (data.status === 'success') {
                const t = data.tuition;
                studentNameInput.value = t.StudentName || '';
                tuitionStatusInput.value = statusMap[t.Status] || t.Status || '';
                feeAmountInput.value = parseInt(t.Amount, 10) || 0;
                feeAmountInput.readOnly = true;
                feeAmountInput.style.background = '#f5f5f5';
                updateTotals();
            } else {
                alert(data.message || 'Không tìm thấy học phí');
                studentNameInput.value = '';
                tuitionStatusInput.value = '';
                feeAmountInput.value = '';
                feeAmountInput.readOnly = false;
                feeAmountInput.style.background = '';
                updateTotals();
            }
        } catch (e) {
            console.error(e);
            alert('Lỗi kết nối dịch vụ học phí');
        }
    }

    searchTuitionBtn.addEventListener('click', () => {
        const sid = studentIdInput.value.trim();
        if (!sid) { alert('Vui lòng nhập mã số sinh viên'); return; }
        fetchTuitionByStudentId(sid);
    });

    updateTotals();

    document.getElementById('registrationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const amount = parseInt(feeAmountInput.value, 10) || 0;
        const balance = parseInt(balanceInput.value, 10) || 0;
        const studentId = studentIdInput.value.trim();
        if (amount <= 0 || amount > balance || !studentId) { return; }

        try {
            submitBtn.textContent = 'Đang gửi OTP qua email...';
            submitBtn.disabled = true;
            const res = await fetch('http://localhost:8080/backend/payment/create_otp.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: user.id, studentId, amount, userEmail: user.email })
            });
            const data = await res.json();
            if (data.status !== 'success') {
                alert(data.message || 'Không tạo được OTP');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Xác nhận giao dịch';
                return;
            }

            const otpInput = prompt('Một mã OTP đã được gửi tới email của bạn. Vui lòng nhập OTP:') || '';
            if (!otpInput) { alert('Bạn chưa nhập OTP'); submitBtn.disabled = false; submitBtn.textContent = 'Xác nhận giao dịch'; return; }

            submitBtn.textContent = 'Đang xác nhận OTP...';
            const res2 = await fetch('http://localhost:8080/backend/payment/confirm_otp.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentId: data.paymentId, otp: otpInput.trim() })
            });
            const data2 = await res2.json();
            if (data2.status !== 'success') {
                alert(data2.message || 'OTP không hợp lệ');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Xác nhận giao dịch';
                return;
            }

            // Refresh user balance locally
            if (data2.user) {
                localStorage.setItem('user', JSON.stringify(data2.user));
                balanceInput.value = Math.floor(data2.user.balance || 0);
                updateTotals();
            }

            const success = document.getElementById('successMessage');
            success.style.display = 'block';
            success.scrollIntoView({ behavior: 'smooth' });
            submitBtn.textContent = 'Giao dịch thành công';
            submitBtn.style.background = '#27ae60';
        } catch (err) {
            console.error(err);
            alert('Lỗi kết nối dịch vụ thanh toán');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Xác nhận giao dịch';
        }
    });
})();
    </script>
</body>
</html>